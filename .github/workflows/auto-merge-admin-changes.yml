name: Auto-merge Admin Video Updates

on:
  pull_request:
    types: [opened, edited, labeled]
    paths:
      - 'app/filmmaking/videos.json'

permissions:
  contents: write
  pull-requests: read

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    if: github.repository == 'banddude/united-studio-collective'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR for admin label
        id: check_approval
        run: |
          # Check if PR has the admin-update label
          # The labels are available in the event payload
          LABELS='${{ toJSON(github.event.pull_request.labels) }}'
          
          if echo "$LABELS" | grep -q "admin-update"; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "✓ Admin label found, will auto-merge"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "✗ Missing 'admin-update' label"
            exit 1
          fi

      - name: Auto-merge PR
        if: steps.check_approval.outputs.approved == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Delete branch after merge
        if: steps.check_approval.outputs.approved == 'true' && github.event.pull_request.merged == true
        run: |
          git push origin --delete ${{ github.event.pull_request.head.ref }}
